# CEX-DEX LP 套利策略 Status 输出示例

## 完整 Status 输出示例

```
======================================================================
                     CEX-DEX LP 套利策略
======================================================================
CEX: binance_perpetual_testnet | DEX: pancakeswap/clmm
交易对: CAKE-USDT         | LP 数量: 0.1
----------------------------------------------------------------------

📈 实时市场数据
----------------------------------------------------------------------
CEX (binance_perpetual_testnet):
   买价 (Ask):     2.153000 USDT  ← 我们买入的价格
   卖价 (Bid):     2.151000 USDT  ← 我们卖出的价格
   中间价:         2.152000 USDT
   价差:             0.0930 %

DEX (pancakeswap/clmm):
   池子价格:       2.180000 USDT
   总流动性:    1250000.00

💰 套利机会分析
----------------------------------------------------------------------
卖方套利 (DEX LP 卖出 → CEX 买入):
   DEX 价格:            2.180000 USDT
   CEX 买价:            2.153000 USDT
   价差:               +0.027000 USDT  (+1.25%)

   目标开仓价:          2.197450 USDT  (需 2.0% 利润)
   最低价格(止损):      2.164100 USDT  (需 0.5% 利润)

   总费用率:              2.42 %
     - CEX 手续费:        0.10 %
     - Gas 成本:          2.32 %
     - 滑点预留:          1.00 %
     - LP 费收入:        -0.30 %

   ❌ 暂无机会
      需要涨幅:           0.017450 USDT  (0.80%)

📊 统计信息
----------------------------------------------------------------------
完成周期:    0
累计利润:    0.0000 USDT
LP开仓失败:  0
对冲失败:    0

======================================================================
```

---

## 有套利机会时的输出

```
======================================================================
                     CEX-DEX LP 套利策略
======================================================================
CEX: binance_perpetual_testnet | DEX: pancakeswap/clmm
交易对: CAKE-USDT         | LP 数量: 0.1
----------------------------------------------------------------------

📈 实时市场数据
----------------------------------------------------------------------
CEX (binance_perpetual_testnet):
   买价 (Ask):     2.100000 USDT  ← 我们买入的价格
   卖价 (Bid):     2.098000 USDT  ← 我们卖出的价格
   中间价:         2.099000 USDT
   价差:             0.0953 %

DEX (pancakeswap/clmm):
   池子价格:       2.180000 USDT
   总流动性:    1250000.00

💰 套利机会分析
----------------------------------------------------------------------
卖方套利 (DEX LP 卖出 → CEX 买入):
   DEX 价格:            2.180000 USDT
   CEX 买价:            2.100000 USDT
   价差:               +0.080000 USDT  (+3.81%)

   目标开仓价:          2.145220 USDT  (需 2.0% 利润)
   最低价格(止损):      2.111552 USDT  (需 0.5% 利润)

   总费用率:              2.42 %
     - CEX 手续费:        0.10 %
     - Gas 成本:          2.38 %
     - 滑点预留:          1.00 %
     - LP 费收入:        -0.30 %

   ✅ 有套利机会！
      预期利润:           0.0033 USDT  (+1.58%)

📊 统计信息
----------------------------------------------------------------------
完成周期:    0
累计利润:    0.0000 USDT
LP开仓失败:  0
对冲失败:    0

======================================================================
```

---

## 有 LP 仓位时的输出

```
======================================================================
                     CEX-DEX LP 套利策略
======================================================================
CEX: binance_perpetual_testnet | DEX: pancakeswap/clmm
交易对: CAKE-USDT         | LP 数量: 0.1
----------------------------------------------------------------------

📈 实时市场数据
----------------------------------------------------------------------
CEX (binance_perpetual_testnet):
   买价 (Ask):     2.105000 USDT  ← 我们买入的价格
   卖价 (Bid):     2.103000 USDT  ← 我们卖出的价格
   中间价:         2.104000 USDT
   价差:             0.0951 %

DEX (pancakeswap/clmm):
   池子价格:       2.175000 USDT
   总流动性:    1250000.00

💰 套利机会分析
----------------------------------------------------------------------
卖方套利 (DEX LP 卖出 → CEX 买入):
   DEX 价格:            2.175000 USDT
   CEX 买价:            2.105000 USDT
   价差:               +0.070000 USDT  (+3.33%)

   目标开仓价:          2.150342 USDT  (需 2.0% 利润)
   最低价格(止损):      2.116627 USDT  (需 0.5% 利润)

   总费用率:              2.42 %
     - CEX 手续费:        0.10 %
     - Gas 成本:          2.38 %
     - 滑点预留:          1.00 %
     - LP 费收入:        -0.30 %

   ✅ 有套利机会！
      预期利润:           0.0028 USDT  (+1.35%)

📊 LP 仓位状态
----------------------------------------------------------------------
方向:        SELL
价格区间:    2.150000 - 2.172000 USDT
均价:        2.161000 USDT
数量:        0.1 CAKE
持仓时间:    45秒 / 300秒
开仓CEX价:   2.100000 USDT
当前CEX价:   2.105000 USDT  (变化: +0.005000, +0.24%)
预期盈亏:    +2.66%  ✅

📊 统计信息
----------------------------------------------------------------------
完成周期:    2
累计利润:    0.0054 USDT
平均利润:    0.0027 USDT
LP开仓失败:  0
对冲失败:    0

======================================================================
```

---

## 价格获取失败时的输出

```
======================================================================
                     CEX-DEX LP 套利策略
======================================================================
CEX: binance_perpetual_testnet | DEX: pancakeswap/clmm
交易对: CAKE-USDT         | LP 数量: 0.1
----------------------------------------------------------------------

📈 实时市场数据
----------------------------------------------------------------------
⚠️  无法获取实时价格: Connection timeout

📊 统计信息
----------------------------------------------------------------------
完成周期:    0
累计利润:    0.0000 USDT
LP开仓失败:  1
对冲失败:    0

======================================================================
```

---

## Status 信息说明

### 📈 实时市场数据

**CEX 价格**:
- **买价 (Ask)**: 我们从 CEX 买入的价格（卖方套利需要）
- **卖价 (Bid)**: 我们向 CEX 卖出的价格（买方套利需要）
- **中间价**: (Ask + Bid) / 2
- **价差**: CEX 买卖价差百分比

**DEX 价格**:
- **池子价格**: 当前 LP 池子的价格
- **总流动性**: 池子的总流动性（如果有的话）

---

### 💰 套利机会分析

#### 卖方套利示例解读

```
DEX 价格:            2.180000 USDT  ← DEX 上能卖的价格
CEX 买价:            2.100000 USDT  ← CEX 上需要买的价格
价差:               +0.080000 USDT  (+3.81%)  ← 原始价差
```

**目标开仓价**:
- 计算公式: `CEX 买价 × (1 + 目标利润 + 费用 - LP 费收入)`
- 含义: DEX LP 价格必须 > 此值才开仓

**最低价格(止损)**:
- 计算公式: `CEX 买价 × (1 + 最低利润 + 费用 - LP 费收入)`
- 含义: 持仓中，如果 LP 均价 < 此值，触发止损

**总费用率分解**:
```
CEX 手续费:   0.10%  ← Taker 费率
Gas 成本:     2.38%  ← 5 USDT / (0.1 × 2.1) = 2.38%
滑点预留:     1.00%  ← 固定预留
LP 费收入:   -0.30%  ← 我们赚的手续费（负数表示收入）
总计:         2.42%  ← 需要覆盖的成本
```

**机会判断**:
- ✅ 有套利机会: `DEX 价格 >= 目标开仓价`
- ❌ 暂无机会: `DEX 价格 < 目标开仓价`
  - 显示需要的涨幅

**预期利润**:
```
预期利润率 = (DEX 价格 - CEX 买价) / CEX 买价 - 总费用率 + LP 费率
预期利润额 = 预期利润率 × 交易价值
```

---

### 📊 LP 仓位状态

**基本信息**:
- **方向**: SELL（卖出）或 BUY（买入）
- **价格区间**: LP 的价格区间
- **均价**: 区间中点，预期成交价
- **数量**: LP 中的 Token 数量
- **持仓时间**: 当前持仓时长 / 最大超时时间

**价格变化**:
- **开仓 CEX 价**: 开仓时的 CEX 价格
- **当前 CEX 价**: 现在的 CEX 价格
- **变化**: 价格变化量和百分比

**预期盈亏**:
- 基于当前 CEX 价格和 LP 均价计算
- ✅ 正盈亏：LP 均价 > CEX 价格（卖方）
- ⚠️  负盈亏：LP 均价 < CEX 价格（可能触发止损）

---

### 📊 统计信息

- **完成周期**: 完成的套利次数
- **累计利润**: 总利润（扣除所有费用）
- **平均利润**: 累计利润 / 完成周期
- **LP 开仓失败**: 开 LP 失败的次数
- **对冲失败**: CEX 对冲失败的次数（严重！）

---

## 如何使用 Status 信息

### 1. 检查价格数据是否正常

如果看到：
```
⚠️  无法获取实时价格
```

**原因**:
- CEX API 连接问题
- DEX Gateway 连接问题
- 网络问题

**解决**:
```bash
# 检查 CEX 连接
balance

# 检查 Gateway 连接
gateway status
```

---

### 2. 判断是否有套利机会

**有机会**:
```
✅ 有套利机会！
   预期利润: 0.0033 USDT  (+1.58%)
```
→ 策略会自动开仓

**暂无机会**:
```
❌ 暂无机会
   需要涨幅: 0.017450 USDT  (0.80%)
```
→ 等待价格变化

**如果长时间无机会**:
- 检查目标利润率是否太高
- 检查 Gas 成本是否太高
- 考虑换交易对或链

---

### 3. 监控 LP 仓位

**正常持仓**:
```
预期盈亏:    +2.66%  ✅
```
→ 继续持有，等待成交

**接近止损**:
```
预期盈亏:    +0.35%  ⚠️
```
→ 接近 0.5% 止损线，可能很快关仓

**已触发止损**（会在日志中看到）:
```
触发止损:
   LP 均价: 2.161000
   止损线: 2.165000
   CEX 价格: 2.110000
```
→ 策略会自动关闭 LP

---

### 4. 检查统计数据

**正常运行**:
```
完成周期:    5
累计利润:    0.0125 USDT
平均利润:    0.0025 USDT
```
→ 策略运行良好

**频繁失败**:
```
LP开仓失败:  10
对冲失败:    0
```
→ LP 开仓问题，检查余额、gas

**严重问题**:
```
对冲失败:    1
```
→ **非常严重！** 说明 LP 成交但 CEX 对冲失败
→ 存在裸露风险，需要立即手动处理！

---

## 优化 Status 显示频率

如果想更频繁地看到更新的数据，可以修改配置：

```yaml
# 在 cex_dex_lp_arbitrage.yml 中
check_interval_seconds: 5  # 从 10 改为 5 秒
```

这样：
- 策略每 5 秒检查一次市场
- 价格缓存每 5 秒更新一次
- `status` 命令显示的数据更新更快

---

## 实时监控建议

### 方法 1: 使用 watch 命令

```bash
# Linux/Mac
watch -n 5 "echo 'status' | nc localhost 1883"

# 或者在 Hummingbot 内
# 每 5 秒手动输入 status
```

### 方法 2: 查看日志

```bash
# 实时查看日志
tail -f logs/logs_strategy.log | grep -E "套利机会|LP 仓位|对冲"
```

### 方法 3: 自定义监控脚本

```python
# monitor.py
import time
import subprocess

while True:
    subprocess.run(["hummingbot", "status"])
    time.sleep(10)
```

---

## 总结

增强后的 `status` 命令现在提供：

✅ **实时价格数据**: CEX 买卖价、DEX 池子价
✅ **价差分析**: 原始价差、目标价格、止损线
✅ **费用分解**: 详细的费用构成
✅ **套利机会**: 是否有机会、预期利润
✅ **仓位监控**: LP 状态、预期盈亏
✅ **统计信息**: 历史表现、失败次数

这些信息可以帮助你：
- 实时了解市场状况
- 判断策略是否正常运行
- 优化配置参数
- 及时发现问题
