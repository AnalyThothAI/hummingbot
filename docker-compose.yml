
services:
  # Redis - 简化版，无密码
  redis:
    container_name: redis
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --save 900 1 --save 300 10
    volumes:
      - ./redis_data:/data
    network_mode: host
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # EMQX - MQTT Broker（需要认证）
  emqx:
    container_name: emqx
    image: emqx/emqx:5.7.0
    restart: unless-stopped
    ports:
      - "1883:1883"      # MQTT端口
      - "8083:8083"      # WebSocket
      - "18083:18083"    # Dashboard
    environment:
      - EMQX_NAME=emqx
      - EMQX_HOST=127.0.0.1
      - EMQX_DASHBOARD__DEFAULT_USERNAME=${EMQX_ADMIN_USER}
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=${EMQX_ADMIN_PASSWORD}
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_ACL_NOMATCH=deny
    volumes:
      - ./emqx_data:/opt/emqx/data
      - ./emqx_log:/opt/emqx/log
      # ✅ 不挂载 etc 目录，使用容器内默认配置
    healthcheck:
      test: ["CMD", "emqx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Gateway - DEX 连接器
  gateway:
    container_name: gateway
    image: hummingbot/gateway:version-2.9.0
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./gateway_files/conf:/home/gateway/conf
      - ./gateway_files/logs:/home/gateway/logs
      - ./gateway_files/db:/home/gateway/db
      - ./shared_certs:/home/gateway/certs
    environment:
      - GATEWAY_PASSPHRASE=${GATEWAY_PASSPHRASE}
      - GATEWAY_PORT=15888
      - DEV=false
      - NODE_OPTIONS=--max-old-space-size=4096
      - LOG_LEVEL=${GATEWAY_LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost:15888 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Hummingbot - 交易机器人
  hummingbot:
    container_name: hummingbot
    image: hummingbot/hummingbot:version-2.9.0
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./hummingbot_files/conf:/home/hummingbot/conf
      - ./hummingbot_files/conf/connectors:/home/hummingbot/conf/connectors
      - ./hummingbot_files/conf/strategies:/home/hummingbot/conf/strategies
      - ./hummingbot_files/conf/scripts:/home/hummingbot/conf/scripts
      - ./hummingbot_files/logs:/home/hummingbot/logs
      - ./hummingbot_files/data:/home/hummingbot/data
      - ./hummingbot_files/scripts:/home/hummingbot/scripts
      - ./shared_certs:/home/hummingbot/certs
    depends_on:
      - redis
      - emqx
      - gateway
    tty: true
    stdin_open: true
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"